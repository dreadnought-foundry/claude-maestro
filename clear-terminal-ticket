#!/bin/bash
# Clear JIRA ticket assignment for current terminal or workspace

SCOPE="${1:-terminal}"  # Default to terminal-specific

if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "Usage: clear-terminal-ticket [terminal|workspace|all]"
    echo ""
    echo "Scopes:"
    echo "  terminal   - Clear ticket for current terminal only (default)"
    echo "  workspace  - Clear ticket for current directory"
    echo "  all        - Clear all ticket assignments"
    exit 0
fi

# Create directories if they don't exist
mkdir -p "$HOME/.claude/terminal_tickets"
mkdir -p "$HOME/.claude/workspace_tickets"

if [ "$SCOPE" == "all" ]; then
    # Clear all assignments
    rm -f "$HOME/.claude/terminal_tickets/"* 2>/dev/null
    rm -f "$HOME/.claude/workspace_tickets/"* 2>/dev/null
    echo "✅ Cleared all ticket assignments"
    
elif [ "$SCOPE" == "workspace" ]; then
    # Clear workspace assignment
    workspace_hash=$(pwd | md5sum | cut -c1-8)
    workspace_ticket_file="$HOME/.claude/workspace_tickets/${workspace_hash}"
    
    if [[ -f "$workspace_ticket_file" ]]; then
        rm -f "$workspace_ticket_file"
        echo "✅ Cleared workspace ticket for: $(pwd)"
    else
        echo "No workspace ticket was set for: $(pwd)"
    fi
    
else
    # Clear terminal assignment
    terminal_id=$(tty 2>/dev/null | sed 's/\//_/g')
    if [[ -z "$terminal_id" || "$terminal_id" == "not a tty" ]]; then
        echo "Error: Could not determine terminal ID"
        echo "This command must be run in an interactive terminal"
        exit 1
    fi
    
    terminal_ticket_file="$HOME/.claude/terminal_tickets/${terminal_id}"
    
    if [[ -f "$terminal_ticket_file" ]]; then
        rm -f "$terminal_ticket_file"
        echo "✅ Cleared terminal ticket for: $(tty)"
    else
        echo "No terminal ticket was set"
    fi
fi