#!/bin/bash
# Assign a JIRA ticket to the current terminal session

TICKET="$1"
SCOPE="${2:-terminal}"  # Default to terminal-specific, or use "workspace" for directory-based

# Validate arguments
if [ -z "$TICKET" ]; then
    echo "Usage: set-terminal-ticket PROJECT-123 [terminal|workspace]"
    echo ""
    echo "Scopes:"
    echo "  terminal   - Assign ticket to current terminal only (default)"
    echo "  workspace  - Assign ticket to current directory (all terminals in this dir)"
    echo ""
    
    # Show current assignments
    terminal_id=$(tty 2>/dev/null | sed 's/\//_/g')
    terminal_ticket_file="$HOME/.claude/terminal_tickets/${terminal_id}"
    workspace_hash=$(pwd | md5sum | cut -c1-8)
    workspace_ticket_file="$HOME/.claude/workspace_tickets/${workspace_hash}"
    
    echo "Current assignments:"
    if [[ -f "$terminal_ticket_file" ]]; then
        echo "  Terminal: $(cat "$terminal_ticket_file")"
    else
        echo "  Terminal: None"
    fi
    
    if [[ -f "$workspace_ticket_file" ]]; then
        echo "  Workspace ($(pwd)): $(cat "$workspace_ticket_file")"
    else
        echo "  Workspace: None"
    fi
    
    exit 1
fi

# Validate ticket format
if [[ ! "$TICKET" =~ ^[A-Z]+-[0-9]+$ ]]; then
    echo "Error: Ticket must be in format PROJECT-123 (e.g., ENGINE-123, CLAUD-56)"
    exit 1
fi

# Create directories if they don't exist
mkdir -p "$HOME/.claude/terminal_tickets"
mkdir -p "$HOME/.claude/workspace_tickets"

if [ "$SCOPE" == "workspace" ]; then
    # Assign to workspace (directory-based)
    workspace_hash=$(pwd | md5sum | cut -c1-8)
    workspace_ticket_file="$HOME/.claude/workspace_tickets/${workspace_hash}"
    echo "$TICKET" > "$workspace_ticket_file"
    echo "✅ Set workspace ticket to: $TICKET"
    echo "   Directory: $(pwd)"
    echo "   All terminals in this directory will show: [$TICKET]"
else
    # Assign to current terminal only
    terminal_id=$(tty 2>/dev/null | sed 's/\//_/g')
    if [[ -z "$terminal_id" || "$terminal_id" == "not a tty" ]]; then
        echo "Error: Could not determine terminal ID"
        echo "This command must be run in an interactive terminal"
        exit 1
    fi
    
    terminal_ticket_file="$HOME/.claude/terminal_tickets/${terminal_id}"
    echo "$TICKET" > "$terminal_ticket_file"
    echo "✅ Set terminal ticket to: $TICKET"
    echo "   Terminal: $(tty)"
    echo "   This terminal will show: [$TICKET]"
fi