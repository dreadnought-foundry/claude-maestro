#!/bin/bash
# Set current JIRA ticket for status line display

TICKET="$1"
SESSION_STATE_FILE="$HOME/.claude/session_state.md"

if [ -z "$TICKET" ]; then
    echo "Usage: set-current-ticket ENGINE-123"
    echo "Current ticket:"
    if [ -f "$SESSION_STATE_FILE" ]; then
        grep "Current JIRA Ticket:" "$SESSION_STATE_FILE" 2>/dev/null || echo "None set"
    else
        echo "None set"
    fi
    exit 1
fi

# Validate ticket format
if [[ ! "$TICKET" =~ ^ENGINE-[0-9]+$ ]]; then
    echo "Error: Ticket must be in format ENGINE-123"
    exit 1
fi

# Create session state file if it doesn't exist
if [ ! -f "$SESSION_STATE_FILE" ]; then
    cat > "$SESSION_STATE_FILE" << EOF
# Claude Code Session State

## Current Context
- Working Directory: $(pwd)
- Git Branch: $(git branch --show-current 2>/dev/null || echo "unknown")

## Current JIRA Ticket
Current JIRA Ticket: $TICKET
EOF
else
    # Update or add current ticket line
    if grep -q "Current JIRA Ticket:" "$SESSION_STATE_FILE"; then
        # Update existing line
        sed -i '' "s/Current JIRA Ticket: .*/Current JIRA Ticket: $TICKET/" "$SESSION_STATE_FILE"
    else
        # Add ticket section if it doesn't exist
        echo "" >> "$SESSION_STATE_FILE"
        echo "## Current JIRA Ticket" >> "$SESSION_STATE_FILE"
        echo "Current JIRA Ticket: $TICKET" >> "$SESSION_STATE_FILE"
    fi
fi

echo "âœ… Set current ticket to: $TICKET"
echo "Status line will now show: [${TICKET}]"